

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tegra TX2一瞥 &mdash; MySummary 1.0 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Progress and confusion of the IOMMU name space" href="Progress and confusion of the IOMMU name space.html" />
    <link rel="prev" title="抽象还是不抽象的问题" href="抽象还是不抽象的问题.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../README.html" class="icon icon-home"> MySummary
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../道德经直译/README.html">《道德经》直译</a></li>
<li class="toctree-l1"><a class="reference internal" href="../花朵的温室/README.html">花朵的温室</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="README.html">软件架构设计</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="什么是软件架构.html">什么是软件架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="大型软件架构设计.html">大型软件架构设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构师具体设计什么.html">架构师具体设计什么</a></li>
<li class="toctree-l2"><a class="reference internal" href="Use Case图有什么用？.html">Use Case图有什么用？</a></li>
<li class="toctree-l2"><a class="reference internal" href="使用软件的四种方法.html">使用软件的四种方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="从单元测试理解软件.html">从单元测试理解软件</a></li>
<li class="toctree-l2"><a class="reference internal" href="名可名.html">名可名</a></li>
<li class="toctree-l2"><a class="reference internal" href="小国寡民.html">小国寡民</a></li>
<li class="toctree-l2"><a class="reference internal" href="需求分析的中心思路.html">需求分析的中心思路</a></li>
<li class="toctree-l2"><a class="reference internal" href="关于自然语言编程的方向问题.html">关于自然语言编程的方向问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="反者道之动——欣赏架构设计的基本逻辑.html">反者道之动——欣赏架构设计的基本逻辑</a></li>
<li class="toctree-l2"><a class="reference internal" href="让代码变立体.html">让代码变立体</a></li>
<li class="toctree-l2"><a class="reference internal" href="生成优秀的架构.html">生成优秀的架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="分支设计要领.html">分支设计要领</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎样做项目管理.html">怎样做项目管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="谈谈子女教育问题.html">谈谈子女教育问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="两种基本的构架表述方法.html">两种基本的构架表述方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="弱者道之用——谈技术工作中的守弱问题.html">弱者道之用——谈技术工作中的守弱问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="在Linux下做性能分析.html">在Linux下做性能分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构设计的0层逻辑.html">架构设计的0层逻辑</a></li>
<li class="toctree-l2"><a class="reference internal" href="解耦设计.html">解耦设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎么做高层设计.html">怎么做高层设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="理解架构版本.html">理解架构版本</a></li>
<li class="toctree-l2"><a class="reference internal" href="PCIE总线的保序模型.html">PCIE总线的保序模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="做与不做都是战略.html">做与不做都是战略</a></li>
<li class="toctree-l2"><a class="reference internal" href="海洋战术式的软件设计方法.html">海洋战术式的软件设计方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="解耦和不解耦.html">解耦和不解耦</a></li>
<li class="toctree-l2"><a class="reference internal" href="再谈“守弱”.html">再谈“守弱”</a></li>
<li class="toctree-l2"><a class="reference internal" href="互斥算法设计.html">互斥算法设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="英文版本的“弱者道之用”.html">英文版本的“弱者道之用”</a></li>
<li class="toctree-l2"><a class="reference internal" href="什么是“守”.html">什么是“守”</a></li>
<li class="toctree-l2"><a class="reference internal" href="从用户功能开始构架系统框架.html">从用户功能开始构架系统框架</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linux发行版的库软件包组织.html">Linux发行版的库软件包组织</a></li>
<li class="toctree-l2"><a class="reference internal" href="地址空间的故事.html">地址空间的故事</a></li>
<li class="toctree-l2"><a class="reference internal" href="工作和读书有什么不同.html">工作和读书有什么不同</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎样快速调试Linux内核.html">怎样快速调试Linux内核</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构设计中的“少了”和“多了”的问题.html">架构设计中的“少了”和“多了”的问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linux iommu和vfio概念空间解构.html">Linux iommu和vfio概念空间解构</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎样做代码Review.html">怎样做代码Review</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎样做客户访谈.html">怎样做客户访谈</a></li>
<li class="toctree-l2"><a class="reference internal" href="RancherOS架构分析.html">RancherOS架构分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="再谈什么是软件架构.html">再谈什么是软件架构</a></li>
<li class="toctree-l2"><a class="reference internal" href="大道曰守，当时曰行.html">大道曰守，当时曰行</a></li>
<li class="toctree-l2"><a class="reference internal" href="不为天下先.html">不为天下先</a></li>
<li class="toctree-l2"><a class="reference internal" href="关于AI的胡说八道.html">关于AI的胡说八道</a></li>
<li class="toctree-l2"><a class="reference internal" href="学习本质？.html">学习本质？</a></li>
<li class="toctree-l2"><a class="reference internal" href="“设计的流程”和“代码的流程”.html">“设计的流程”和“代码的流程”</a></li>
<li class="toctree-l2"><a class="reference internal" href="概要设计不是代码.html">概要设计不是代码</a></li>
<li class="toctree-l2"><a class="reference internal" href="“病病”.html">“病病”</a></li>
<li class="toctree-l2"><a class="reference internal" href="关于架构师的爱恨情仇——《黑客帝国》世界观解读.html">关于架构师的爱恨情仇——《黑客帝国》世界观解读</a></li>
<li class="toctree-l2"><a class="reference internal" href="vfio-mdev逻辑空间分析.html">vfio-mdev逻辑空间分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linux Socket 0拷贝特性.html">Linux Socket 0拷贝特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="用户态DMA的问题.html">用户态DMA的问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="Multiprocess Support for Linux IOMMU driver.html">Multiprocess Support for Linux IOMMU driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linux RAS特性分析.html">Linux RAS特性分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="写论文.html">写论文</a></li>
<li class="toctree-l2"><a class="reference internal" href="基于“语义”编程.html">基于“语义”编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="从学习assert的用法开始理解如何写“专业的程序”.html">从学习assert的用法开始理解如何写“专业的程序”</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构的存在性.html">架构的存在性</a></li>
<li class="toctree-l2"><a class="reference internal" href="Makefile概念入门.html">Makefile概念入门</a></li>
<li class="toctree-l2"><a class="reference internal" href="ARM服务器进展小结.html">ARM服务器进展小结</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎么做初步的需求分析.html">怎么做初步的需求分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="关于设计方案中的逻辑链问题.html">关于设计方案中的逻辑链问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="从逻辑链问题讨论怎么做高层设计.html">从逻辑链问题讨论怎么做高层设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="工程逻辑链.html">工程逻辑链</a></li>
<li class="toctree-l2"><a class="reference internal" href="为什么你会在你的数据中心中部署ARM服务器.html">为什么你会在你的数据中心中部署ARM服务器</a></li>
<li class="toctree-l2"><a class="reference internal" href="如何为libvirt设置虚拟主机.html">如何为libvirt设置虚拟主机</a></li>
<li class="toctree-l2"><a class="reference internal" href="给普通人解释Spectre和Meltdown安全漏洞.html">给普通人解释Spectre和Meltdown安全漏洞</a></li>
<li class="toctree-l2"><a class="reference internal" href="给程序员解释Spectre和Meltdown漏洞.html">给程序员解释Spectre和Meltdown漏洞</a></li>
<li class="toctree-l2"><a class="reference internal" href="Is retpoline really safe.html">Is retpoline really safe?</a></li>
<li class="toctree-l2"><a class="reference internal" href="逻辑链，道，学和架构工作的本质.html">逻辑链，道，学和架构工作的本质</a></li>
<li class="toctree-l2"><a class="reference internal" href="Serverless是什么——谈如何捕获一个特性的架构本质.html">Serverless是什么——谈如何捕获一个特性的架构本质</a></li>
<li class="toctree-l2"><a class="reference internal" href="道法自然.html">道法自然</a></li>
<li class="toctree-l2"><a class="reference internal" href="自然，守弱和Plan B.html">自然，守弱和Plan B</a></li>
<li class="toctree-l2"><a class="reference internal" href="守弱的内涵和外延.html">守弱的内涵和外延</a></li>
<li class="toctree-l2"><a class="reference internal" href="找到道法自然的“度”.html">找到道法自然的“度”</a></li>
<li class="toctree-l2"><a class="reference internal" href="Specification的写法问题.html">Specification的写法问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="小姐和丫鬟的故事.html">小姐和丫鬟的故事</a></li>
<li class="toctree-l2"><a class="reference internal" href="知不知.html">知不知</a></li>
<li class="toctree-l2"><a class="reference internal" href="PCIE总线的地址问题.html">PCIE总线的地址问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="气和深度学习.html">气和深度学习</a></li>
<li class="toctree-l2"><a class="reference internal" href="单元测试的效果问题.html">单元测试的效果问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="Requirement Analyzing vs. Voting.html">Requirement Analyzing vs. Voting</a></li>
<li class="toctree-l2"><a class="reference internal" href="抽离设计逻辑.html">抽离设计逻辑</a></li>
<li class="toctree-l2"><a class="reference internal" href="盗夸.html">盗夸</a></li>
<li class="toctree-l2"><a class="reference internal" href="抽象还是不抽象的问题.html">抽象还是不抽象的问题</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Tegra TX2一瞥</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">第一印象</a></li>
<li class="toctree-l3"><a class="reference internal" href="#io">IO子系统</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nvmap">nvmap</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">附录</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Progress and confusion of the IOMMU name space.html">Progress and confusion of the IOMMU name space</a></li>
<li class="toctree-l2"><a class="reference internal" href="一样还是不一样.html">一样还是不一样</a></li>
<li class="toctree-l2"><a class="reference internal" href="运营还是交付.html">运营还是交付</a></li>
<li class="toctree-l2"><a class="reference internal" href="科普一下GPL和开源软件.html">科普一下GPL和开源软件</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎么确定道.html">怎么确定道</a></li>
<li class="toctree-l2"><a class="reference internal" href="回调还是直调.html">回调还是直调</a></li>
<li class="toctree-l2"><a class="reference internal" href="接口的封装层次问题.html">接口的封装层次问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="git的基本架构欣赏.html">git的基本架构欣赏</a></li>
<li class="toctree-l2"><a class="reference internal" href="让设计自生.html">让设计自生</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构控制的从权问题.html">架构控制的从权问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="设计的需求问题.html">设计的需求问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="性能优化的目标问题.html">性能优化的目标问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="加速器和其他硬件的区别.html">加速器和其他硬件的区别</a></li>
<li class="toctree-l2"><a class="reference internal" href="君子与其练达不若朴鲁与其曲谨不若疏狂.html">君子与其练达不若朴鲁与其曲谨不若疏狂</a></li>
<li class="toctree-l2"><a class="reference internal" href="有无之道——一个新的软件架构定义.html">有无之道——一个新的软件架构定义</a></li>
<li class="toctree-l2"><a class="reference internal" href="什么是管理.html">什么是管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="从香农熵谈设计文档写作.html">从香农熵谈设计文档写作</a></li>
<li class="toctree-l2"><a class="reference internal" href="YVR18资料关注点.html">YVR18资料关注点</a></li>
<li class="toctree-l2"><a class="reference internal" href="理解关联.html">理解关联</a></li>
<li class="toctree-l2"><a class="reference internal" href="如何撰写技术交底书.html">如何撰写技术交底书</a></li>
<li class="toctree-l2"><a class="reference internal" href="infiniband概念空间分析.html">infiniband概念空间分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="再谈什么是高层设计.html">再谈什么是高层设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="再谈“法自然”的设计思路.html">再谈“法自然”的设计思路</a></li>
<li class="toctree-l2"><a class="reference internal" href="设计规范.html">设计规范</a></li>
<li class="toctree-l2"><a class="reference internal" href="开源交付.html">开源交付</a></li>
<li class="toctree-l2"><a class="reference internal" href="道纪.html">道纪</a></li>
<li class="toctree-l2"><a class="reference internal" href="X86上的ARM Linux调试环境.html">X86上的ARM Linux调试环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="IOMMU的现状和发展.html">IOMMU的现状和发展</a></li>
<li class="toctree-l2"><a class="reference internal" href="单元测试的强与弱问题.html">单元测试的强与弱问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="做事，做名，绩效主义，以及架构战略.html">做事，做名，绩效主义，以及架构战略</a></li>
<li class="toctree-l2"><a class="reference internal" href="没有规则的规则.html">没有规则的规则</a></li>
<li class="toctree-l2"><a class="reference internal" href="大成若缺.html">大成若缺</a></li>
<li class="toctree-l2"><a class="reference internal" href="非易失内存随想.html">非易失内存随想</a></li>
<li class="toctree-l2"><a class="reference internal" href="参考平台.html">参考平台</a></li>
<li class="toctree-l2"><a class="reference internal" href="一个例子：名的边界效应.html">一个例子：名的边界效应</a></li>
<li class="toctree-l2"><a class="reference internal" href="抽象问题的模型.html">抽象问题的模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="另一个例子：名的边界效应.html">另一个例子：名的边界效应</a></li>
<li class="toctree-l2"><a class="reference internal" href="Zircon架构简单分析1: Overview.html">Zircon架构简单分析1: Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="在qemu中模拟设备.html">在qemu中模拟设备</a></li>
<li class="toctree-l2"><a class="reference internal" href="国产操作系统问题.html">国产操作系统问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="软件飞线.html">软件飞线</a></li>
<li class="toctree-l2"><a class="reference internal" href="状态机方法.html">状态机方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="一些典型的架构设计错误.html">一些典型的架构设计错误</a></li>
<li class="toctree-l2"><a class="reference internal" href="从CPU和TPU的不同语言抽象看抽象原则.html">从CPU和TPU的不同语言抽象看抽象原则</a></li>
<li class="toctree-l2"><a class="reference internal" href="限制管理.html">限制管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="WarpDrive as a General Heterogeneous Platform.html">WarpDrive as a General Heterogeneous Platform</a></li>
<li class="toctree-l2"><a class="reference internal" href="Multiarch概念调查.html">Multiarch概念调查</a></li>
<li class="toctree-l2"><a class="reference internal" href="ARM NUC.html">ARM NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="UML有没有用.html">UML有没有用</a></li>
<li class="toctree-l2"><a class="reference internal" href="推演一个Buffer分配的语法设计.html">推演一个Buffer分配的语法设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构师和项目经理的基本职责问题.html">架构师和项目经理的基本职责问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="锁使用设计.html">锁使用设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="从内核终止用户态程序的IO访问.html">从内核终止用户态程序的IO访问</a></li>
<li class="toctree-l2"><a class="reference internal" href="epoll和select.html">epoll和select</a></li>
<li class="toctree-l2"><a class="reference internal" href="状态机退出方法.html">状态机退出方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="不为天下先2.html">不为天下先2</a></li>
<li class="toctree-l2"><a class="reference internal" href="设计逻辑和代码逻辑.html">设计逻辑和代码逻辑</a></li>
<li class="toctree-l2"><a class="reference internal" href="流水线深度.html">流水线深度</a></li>
<li class="toctree-l2"><a class="reference internal" href="谁是主线？.html">谁是主线？</a></li>
<li class="toctree-l2"><a class="reference internal" href="理解指令集.html">理解指令集</a></li>
<li class="toctree-l2"><a class="reference internal" href="给使用设备的进程发信号.html">给使用设备的进程发信号</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linux设备异常复位逻辑分析.html">Linux设备异常复位逻辑分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="投资开源社区的基本逻辑.html">投资开源社区的基本逻辑</a></li>
<li class="toctree-l2"><a class="reference internal" href="一个Linux死锁信息分析.html">一个Linux死锁信息分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="如何说谎.html">如何说谎</a></li>
<li class="toctree-l2"><a class="reference internal" href="代码生成器.html">代码生成器</a></li>
<li class="toctree-l2"><a class="reference internal" href="弟子规：美国军方禁止在C语言程序中使用malloc.html">弟子规：美国军方禁止在C语言程序中使用malloc</a></li>
<li class="toctree-l2"><a class="reference internal" href="自下而上和自上而下的设计.html">自下而上和自上而下的设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="正面竞争.html">正面竞争</a></li>
<li class="toctree-l2"><a class="reference internal" href="不知为美.html">不知为美</a></li>
<li class="toctree-l2"><a class="reference internal" href="高层封装的设计战略.html">高层封装的设计战略</a></li>
<li class="toctree-l2"><a class="reference internal" href="产业生态的原理和作用.html">产业生态的原理和作用</a></li>
<li class="toctree-l2"><a class="reference internal" href="弯道问题.html">弯道问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="无名概念的深入探讨.html">无名概念的深入探讨</a></li>
<li class="toctree-l2"><a class="reference internal" href="解释On-Chip Debug和Off-Chip Debug.html">解释On-Chip Debug和Off-Chip Debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="接口和名称空间辨识.html">接口和名称空间辨识</a></li>
<li class="toctree-l2"><a class="reference internal" href="RISCV WMO和TSO具体解决什么问题.html">RISCV WMO和TSO具体解决什么问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="利益链.html">利益链</a></li>
<li class="toctree-l2"><a class="reference internal" href="从C的for和Python的for聊起.html">从C的for和Python的for聊起</a></li>
<li class="toctree-l2"><a class="reference internal" href="安全建模问题讨论.html">安全建模问题讨论</a></li>
<li class="toctree-l2"><a class="reference internal" href="Accelerator vs. Co-processor.html">Accelerator vs. Co-processor</a></li>
<li class="toctree-l2"><a class="reference internal" href="一个逻辑空间控制的例子：uacce生命周期管理.html">一个逻辑空间控制的例子：uacce生命周期管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="软件构架设计的入题角度问题.html">软件构架设计的入题角度问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="接口分层的问题.html">接口分层的问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="对Cache Coherence的重理解.html">对Cache Coherence的重理解</a></li>
<li class="toctree-l2"><a class="reference internal" href="接口定义的工作模型.html">接口定义的工作模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linux_net和net-next分支的维护策略.html">Linux net和net-next分支的维护策略</a></li>
<li class="toctree-l2"><a class="reference internal" href="WarpDrive用户态方案重构建议.html">WarpDrive用户态方案重构建议</a></li>
<li class="toctree-l2"><a class="reference internal" href="主线逻辑.html">主线逻辑</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构设计的粗与细问题.html">架构设计的粗与细问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="狂人日记读后感——名称空间囚笼.html">狂人日记读后感——名称空间囚笼</a></li>
<li class="toctree-l2"><a class="reference internal" href="写程序和写小说的区别.html">写程序和写小说的区别</a></li>
<li class="toctree-l2"><a class="reference internal" href="再谈《弟子规》问题.html">再谈《弟子规》问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="理解弱内存顺序模型.html">理解弱内存顺序模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="思维上的洞2.html">思维上的洞2</a></li>
<li class="toctree-l2"><a class="reference internal" href="后软件时代和技术沙盘陷阱.html">后软件时代和技术沙盘陷阱</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎么做项目管理2.html">怎么做项目管理2</a></li>
<li class="toctree-l2"><a class="reference internal" href="语言的控制力问题.html">语言的控制力问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="分享我的Linux内核开发环境.html">分享我的Linux内核开发环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="开发视图.html">开发视图</a></li>
<li class="toctree-l2"><a class="reference internal" href="概念视图.html">概念视图</a></li>
<li class="toctree-l2"><a class="reference internal" href="处理视图.html">处理视图</a></li>
<li class="toctree-l2"><a class="reference internal" href="语言控制力问题.html">语言控制力问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="新手设计文档典型错误.html">新手设计文档典型错误</a></li>
<li class="toctree-l2"><a class="reference internal" href="讨论：OpenCL2.0SVM有什么好？.html">讨论：OpenCL2.0SVM有什么好？</a></li>
<li class="toctree-l2"><a class="reference internal" href="设计逻辑的细致和严密问题.html">设计逻辑的细致和严密问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="逻辑的平面和立体问题.html">逻辑的平面和立体问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="自由和约束.html">自由和约束</a></li>
<li class="toctree-l2"><a class="reference internal" href="给非专业人士介绍架构设计工作.html">给非专业人士介绍架构设计工作</a></li>
<li class="toctree-l2"><a class="reference internal" href="AML工作原理快速调研.html">AML工作原理快速调研</a></li>
<li class="toctree-l2"><a class="reference internal" href="qemu_PCIe总线结构.html">qemu PCIe总线结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="ARM64_Linux_Kernel_5.7无法GDB调试问题.html">ARM64 Linux Kernel 5.7无法GDB调试问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="分层抽象.html">分层抽象</a></li>
<li class="toctree-l2"><a class="reference internal" href="见素抱朴：一个关于交付的例子.html">见素抱朴：一个关于交付的例子</a></li>
<li class="toctree-l2"><a class="reference internal" href="三个锦囊.html">三个锦囊</a></li>
<li class="toctree-l2"><a class="reference internal" href="多核MMU和ASID管理逻辑.html">多核MMU和ASID管理逻辑</a></li>
<li class="toctree-l2"><a class="reference internal" href="PMA和PA方案对比.html">PMA和PA方案对比</a></li>
<li class="toctree-l2"><a class="reference internal" href="真假架构设计.html">真假架构设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="怎样写标准提案.html">怎样写标准提案</a></li>
<li class="toctree-l2"><a class="reference internal" href="安全问题的本质.html">安全问题的本质</a></li>
<li class="toctree-l2"><a class="reference internal" href="名称内涵的发展.html">名称内涵的发展</a></li>
<li class="toctree-l2"><a class="reference internal" href="标准和设计的区别.html">标准和设计的区别</a></li>
<li class="toctree-l2"><a class="reference internal" href="cond_mutex模型.html">cond/mutex模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="一个例子：架构的重要性和从权.html">一个例子：架构的重要性和从权</a></li>
<li class="toctree-l2"><a class="reference internal" href="nvdimm_AD模式的内核应用模型.html">nvdimm AD模式的内核应用模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="早期架构设计问题.html">早期架构设计问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="所谓内部设计.html">所谓内部设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="“知不知”如何影响决策的？.html">“知不知”如何影响决策的？</a></li>
<li class="toctree-l2"><a class="reference internal" href="“优秀架构设计”.html">“优秀架构设计”</a></li>
<li class="toctree-l2"><a class="reference internal" href="Linux_Kernel架构赏析.html">Linux Kernel架构赏析</a></li>
<li class="toctree-l2"><a class="reference internal" href="说说对协程的看法.html">说说对协程的看法</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构设计和实施的对齐和同步问题.html">架构设计和实施的对齐和同步问题</a></li>
<li class="toctree-l2"><a class="reference internal" href="一个关于4+1视图的案例：从概念视图开始.html">一个关于4+1视图的案例：从概念视图开始</a></li>
<li class="toctree-l2"><a class="reference internal" href="“硬件状态机”.html">“硬件状态机”</a></li>
<li class="toctree-l2"><a class="reference internal" href="设计的减熵原理.html">设计的减熵原理</a></li>
<li class="toctree-l2"><a class="reference internal" href="binfmt概念空间建模.html">binfmt概念空间建模</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构设计入门知识.html">架构设计入门知识</a></li>
<li class="toctree-l2"><a class="reference internal" href="架构设计的大忌：我没错.html">架构设计的大忌：我没错</a></li>
<li class="toctree-l2"><a class="reference internal" href="“解决方案”.html">“解决方案”</a></li>
<li class="toctree-l2"><a class="reference internal" href="讨论一下eBPF.html">讨论一下eBPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="交付中的Version和Revision.html">交付中的Version和Revision</a></li>
<li class="toctree-l2"><a class="reference internal" href="约束选择.html">约束选择</a></li>
<li class="toctree-l2"><a class="reference internal" href="在概念空间选择方案.html">在概念空间选择方案</a></li>
<li class="toctree-l2"><a class="reference internal" href="git-submodule的理解.html">git submodule的理解</a></li>
<li class="toctree-l2"><a class="reference internal" href="思维的串行化要求.html">思维的串行化要求</a></li>
<li class="toctree-l2"><a class="reference internal" href="什么是函数式编程.html">什么是函数式编程</a></li>
<li class="toctree-l2"><a class="reference internal" href="管理上的判断和技术上的判断.html">管理上的判断和技术上的判断</a></li>
<li class="toctree-l2"><a class="reference internal" href="基于逻辑链建立约束.html">基于逻辑链建立约束</a></li>
<li class="toctree-l2"><a class="reference internal" href="高级需求分析.html">高级需求分析</a></li>
<li class="toctree-l2"><a class="reference internal" href="False_Sharing.html">假共享内存(False Sharing)</a></li>
<li class="toctree-l2"><a class="reference internal" href="芯片验证软件的4+1方法.html">芯片验证软件的4+1方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="软件之硬.html">软件之硬</a></li>
<li class="toctree-l2"><a class="reference internal" href="诚其意.html">诚其意</a></li>
<li class="toctree-l2"><a class="reference internal" href="把什么放入架构设计.html">把什么放入架构设计</a></li>
<li class="toctree-l2"><a class="reference internal" href="线程的本质.html">线程的本质</a></li>
<li class="toctree-l2"><a class="reference internal" href="限制的可移动性.html">限制的可移动性</a></li>
<li class="toctree-l2"><a class="reference internal" href="指令寻址模式.html">指令寻址模式</a></li>
<li class="toctree-l2"><a class="reference internal" href="ARMv8的安全特性的主线逻辑.html">ARMv8的安全特性的主线逻辑</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Linux主线内核跟踪/README.html">Linux主线内核跟踪</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../README.html">MySummary</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../README.html">Docs</a> &raquo;</li>
        
          <li><a href="README.html">软件架构设计</a> &raquo;</li>
        
      <li>Tegra TX2一瞥</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/软件构架设计/Tegra TX2一瞥.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tegra-tx2">
<h1>Tegra TX2一瞥<a class="headerlink" href="#tegra-tx2" title="永久链接至标题">¶</a></h1>
<p>最近入手了一台Tegra TX2做玩具，职业习惯，快速总结一下这个东西，供其他有兴趣的同
学参考。（注：一如过往，这只是快速形成的印象，不保证正确性，如果你信这个搞出什
么问题来，别回来找我）。</p>
<p>这个总结分三部分写：</p>
<ol class="arabic simple">
<li>第一印象</li>
<li>IO子系统</li>
<li>内存子系统分析</li>
</ol>
<div class="section" id="id1">
<h2>第一印象<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>首先说说硬件，总的来说，我还是很喜欢这个硬件的：</p>
<blockquote>
<div><div class="figure">
<img alt="../_images/tx2-1.jpg" src="../_images/tx2-1.jpg" />
</div>
</div></blockquote>
<p>关键是小巧玲珑，到处带很容易，而且机能基本上足够：本地编译Kernel，基于Docker启
动个web服务器，都没有什么困难。</p>
<p>对于小巧玲珑这一点，估计用惯树莓派或者HiKey这种板子的人会有不同意见。但这两个东
西用来做开发，完全不够看。要知道我平时在家里用的都是这样的货色：</p>
<blockquote>
<div><div class="figure">
<img alt="../_images/tx2-2.jpg" src="../_images/tx2-2.jpg" />
</div>
</div></blockquote>
<p>接着说软件——简单总结，这个东西具有一切商业公司对待开源社区的傲慢无知的缺点。</p>
<p>你说你做一块自恰的单板，你直接给我做一个USB启动，直接插盘安装不就完了？它偏不，
非要做一个管理软件（JetPack），把一台服务器形态的单板做成一个嵌入式单板，
JetPack需要先安装到Host上，然后用Host来安装Target。</p>
<p>最大的问题是，这个JetPack安装的时候，默认安装目标是安装程序本身的路径，而且一旦
你确认，立即删除同目录下的所有文件，问都不问一声：</p>
<blockquote>
<div><div class="figure">
<img alt="../_images/tx2-3.jpg" src="../_images/tx2-3.jpg" />
</div>
</div></blockquote>
<p>（看不清的话，这里是手册上的内容清单：</p>
<blockquote>
<div><div class="line-block">
<div class="line">OS Image:</div>
<div class="line-block">
<div class="line">A sample file system derived from Ubuntu for Jetson</div>
</div>
<div class="line">Libraries:</div>
<div class="line-block">
<div class="line">CUDA Toolkit for Host PC (Ubuntu with cross-development support)</div>
<div class="line">CUDA Toolkit for Jetson</div>
<div class="line">OpenCV</div>
<div class="line">VisionWorks</div>
<div class="line">cuDNN</div>
<div class="line">TensorRT</div>
<div class="line">MultiMedia API</div>
</div>
<div class="line">Dev Tools:</div>
<div class="line-block">
<div class="line">NV System Profiler Tegra Graphics Debugger (OpenGL调试）</div>
<div class="line">Sample Code</div>
</div>
<div class="line">Documentation</div>
</div>
</div></blockquote>
<p>）</p>
<p>真是自来熟，不把自己当外人啊。这风格和cuda那一堆库那样，装起来就到处撒东西，装
完机器就不是你的了。一副缺乏竞争，“你不用我不行”，为所欲为的模样。</p>
<p>(这个安装也是一样的，直接给我的PC加了dpkg --add-architecture arm64，装binutils
，把我的本地库管理弄得一塌糊涂，直接锁住了一堆本地程序的升级——关键是包括安全升
级。弄得我装好Target就把这个Host给卸了，还卸了半天）</p>
<p>不说这个安装过程要翻某某神秘障碍物了，更神奇的是，你看着它是个图形界面，实际上
，它里面是个脚本调用，而且这个调用过程调了sudo，所以，如果你不仔细看它的日志窗
口，在里面输一下密码，这个安装过程会永远挂在这里。</p>
<p>出现这种问题，怎么看都是毫无开源文化的商业公司，找了几个小外包，根据需求说明单
一天天算钱做出来的。</p>
<p>这一点也表现在内核的下载上，你说你要给我源代码，你给内核的git路径不就结了吗，结
果你做了这个：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jetsonhacks</span><span class="o">/</span><span class="n">buildJetsonTX2Kernel</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<p>里面居然仅仅是下载kernel的脚本</p>
<p>而执行这个脚本，居然又在里面调sudo。大哥，我就下载个Kernel源码，这和sudo权限啥
关系啊？</p>
<p>有了前面被删光download目录的经验，这次我去看了一下sudo是干哈的——原来它非要把内
核给我下载到/usr/src目录下——谁告诉你我一定会在目标系统上编译这个代码啊？</p>
<p>再说了，makeKernel我也就只是想编译一下，我没想要替换现在的内核啊，你给我拷上去
又算怎么回事？……</p>
<p>无论如何吧，这次源代码中是一个.o都没有了，不再玩原来nv驱动那种“用户自己链接，所
以我不用开源”的游戏了。这也算一大进步。</p>
<p>再说说TensorFlow，你说你买TX2，一般就是想搞TF, Caffe,MXNet一类的东西了。这些应
该默认就可以正常工作吧——现实是，我现在都没有能够装起来。TX2默认装的是Cuda9，官
网给的方案TensorFlow是基于Cuda8的，没法用。后来给了一个Cuda9的版本，跑起来还是
去找Cuda8的库，这个我晚点再去折腾吧。</p>
<p>总的来说，第一印象来说，硬件不错，软件渣渣。最后给一个perf的性能数据做对比：</p>
<p>TX2的：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nvidia@tegra-ubuntu:~/work/tegra-tx2-kernel/kernel-4.4/tools/perf$ sudo
./perf bench all [sudo] password for nvidia: # Running sched/messaging
benchmark...  # 20 sender and receiver processes per group # 10 groups ==
400 processes run

Total time: 0.382 [sec]

# Running sched/pipe benchmark...  # Executed 1000000 pipe operations
between two processes

Total time: 30.084 [sec]

30.084290 usecs/op 33239 ops/sec

# Running mem/memcpy benchmark...  # function &#39;default&#39; (Default memcpy()
provided by glibc) # Copying 1MB bytes ...

3.985969 GB/sec

# Running mem/memset benchmark...  # function &#39;default&#39; (Default memset()
provided by glibc) # Copying 1MB bytes ...

4.002305 GB/sec
</pre></div>
</div>
<p>作为对比，这是我的Carbon X1 2017的：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Running sched/messaging benchmark...  # 20 sender and receiver processes</span>
<span class="n">per</span> <span class="n">group</span> <span class="c1"># 10 groups == 400 processes run</span>

<span class="n">Total</span> <span class="n">time</span><span class="p">:</span> <span class="mf">0.218</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span>

<span class="c1"># Running sched/pipe benchmark...  # Executed 1000000 pipe operations</span>
<span class="n">between</span> <span class="n">two</span> <span class="n">processes</span>

<span class="n">Total</span> <span class="n">time</span><span class="p">:</span> <span class="mf">4.265</span> <span class="p">[</span><span class="n">sec</span><span class="p">]</span>

<span class="mf">4.265017</span> <span class="n">usecs</span><span class="o">/</span><span class="n">op</span> <span class="mi">234465</span> <span class="n">ops</span><span class="o">/</span><span class="n">sec</span>

<span class="c1"># Running mem/memcpy benchmark...  # function &#39;default&#39; (Default memcpy()</span>
<span class="n">provided</span> <span class="n">by</span> <span class="n">glibc</span><span class="p">)</span> <span class="c1"># Copying 1MB bytes ...</span>

<span class="mf">34.877232</span> <span class="n">GB</span><span class="o">/</span><span class="n">sec</span> <span class="c1"># function &#39;x86-64-unrolled&#39; (unrolled memcpy() in</span>
<span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">memcpy_64</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="c1"># Copying 1MB bytes ...</span>

<span class="mf">23.251488</span> <span class="n">GB</span><span class="o">/</span><span class="n">sec</span> <span class="c1"># function &#39;x86-64-movsq&#39; (movsq-based memcpy() in</span>
<span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">memcpy_64</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="c1"># Copying 1MB bytes ...</span>

<span class="mf">44.389205</span> <span class="n">GB</span><span class="o">/</span><span class="n">sec</span> <span class="c1"># function &#39;x86-64-movsb&#39; (movsb-based memcpy() in</span>
<span class="n">arch</span><span class="o">/</span><span class="n">x86</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">memcpy_64</span><span class="o">.</span><span class="n">S</span><span class="p">)</span> <span class="c1"># Copying 1MB bytes ...</span>

<span class="mf">44.389205</span> <span class="n">GB</span><span class="o">/</span><span class="n">sec</span>

<span class="c1"># Running mem/memset benchmark...  # function &#39;default&#39; (Default memset()</span>
<span class="n">provided</span> <span class="n">by</span> <span class="n">glibc</span><span class="p">)</span> <span class="c1"># Copying 1MB bytes ...</span>

<span class="mf">54.253472</span> <span class="n">GB</span><span class="o">/</span><span class="n">sec</span>

    <span class="o">..</span> <span class="n">figure</span><span class="p">::</span> <span class="n">_static</span><span class="o">/</span><span class="n">tx2</span><span class="o">-</span><span class="mf">4.</span><span class="n">png</span>
</pre></div>
</div>
<p>6个A57，慢不到10倍，比起模拟器，还可以接受啦。</p>
</div>
<div class="section" id="io">
<h2>IO子系统<a class="headerlink" href="#io" title="永久链接至标题">¶</a></h2>
<p>TX2的启动系统使用的是UEFI+dtb=&gt;grub=&gt;kernel的方案，文件系统使用标准的Ubuntu
ARM64版本（可能经过定制，但至少apt source是标准的）。</p>
<p>（但我怀疑这里做错了，如果用UEFI方案，正确的方法应该是把单独UEFI放在一个fat目录
下，这样最初的加载程序只需要解释fat目录就可以了。现在把UEFI和它东西放在一起，就
发挥不出UEFI和grub加载多种文件系统的效果了）</p>
<p>直接查dtb的compatible，有如下外设（我感兴趣的都标记了对应的驱动，方括号是未入主
线的代码）：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>compatible = &quot;a-edp,1080p-14-0&quot;; [drivers/video/tegra/dc/panel/panel-a-edp-1080p-14-0.c]
compatible = &quot;a-edp,1080p-14-0-bl&quot;;
compatible = &quot;ak,ak89xx&quot;;(iio/imu/inv_mpu/inv_compass/inv_ak89xx_core.c)
compatible = &quot;android,CustomIPI&quot;;(kernel/smp.c)
compatible = &quot;android,firmware&quot;;(drivers/platform/tegra/firmwares-all.c)
compatible = &quot;android,trusty-fiq-v1&quot;;
compatible = &quot;android,trusty-irq-v1&quot;;
compatible = &quot;android,trusty-log-v1&quot;;
compatible = &quot;android,trusty-ote-v1&quot;;
compatible = &quot;android,trusty-smc-v1&quot;;
compatible = &quot;android,trusty-virtio-v1&quot;;
compatible = &quot;arm,armv8-pmuv3&quot;;
compatible = &quot;arm,armv8-timer&quot;;
compatible = &quot;arm,coresight-etm3x&quot;, &quot;arm,primecell&quot;;
compatible = &quot;arm,coresight-etm4x&quot;, &quot;arm,primecell&quot;;
compatible = &quot;arm,coresight-funnel&quot;, &quot;arm,primecell&quot;;
compatible = &quot;arm,coresight-replicator&quot;;
compatible = &quot;arm,coresight-stm&quot;, &quot;arm,primecell&quot;;
compatible = &quot;arm,coresight-tmc&quot;, &quot;arm,primecell&quot;;
compatible = &quot;arm,coresight-tpiu&quot;, &quot;arm,primecell&quot;;
compatible = &quot;arm,cortex-a15-gic&quot;;
compatible = &quot;arm,cortex-a57-64bit&quot;, &quot;arm,armv8&quot;;
compatible = &quot;arm,mmu-500&quot;;
compatible = &quot;arm,psci-1.0&quot;;
compatible = &quot;bmp,bmpX80&quot;;（drivers/iio/pressure/nvi_bmpX80.c）
compatible = &quot;bosch,mttcan&quot;;[drivers/staging/mttcan/m_ttcan_linux.c]
compatible = &quot;bosch,mttcan-ivc&quot;;
compatible = &quot;cache&quot;;
compatible = &quot;capella,cm32180&quot;;（drivers/iio/light/nvs_cm3218.c）
compatible = &quot;dp, display&quot;;
compatible = &quot;dummy-cooling-dev&quot;;
compatible = &quot;extcon-gpio-states&quot;;
compatible = &quot;fixed-clock&quot;;
compatible = &quot;gpio-keys&quot;;
compatible = &quot;gps-wake&quot;;
compatible = &quot;hdmi,display&quot;;
compatible = &quot;invensense,mpu6xxx&quot;;（iio/imu/nvi_mpu/nvi.c）
compatible = &quot;linux,spdif-dit&quot;;（sound/soc/codecs/spdif_transmitter.c）
compatible = &quot;maxim,max16984-tegra186-cdp-phy&quot;;（drivers/phy/phy-max16984-cdp.c）
compatible = &quot;maxim,max20024&quot;;（drivers/mfd/max77620.c）
compatible = &quot;null,dsi-hotplug&quot;;
compatible = &quot;nvidia, tegra-camera-platform&quot;;（drivers/video/tegra/camera/tegra_camera_platform.c）
compatible = &quot;nvidia, tegra186-mipical&quot;;（drivers/media/platform/tegra/mipical/mipi_cal.c）
compatible = &quot;nvidia,bwmgr&quot;;（drivers/platform/tegra/mc/emc_bwmgr.c）
compatible = &quot;nvidia,carveouts&quot;;[drivers/video/tegra/nvmap/nvmap_init.c]
compatible = &quot;nvidia,denver&quot;, &quot;arm,armv8&quot;;[drivers/platform/tegra/tegra18_perf_uncore.c]
compatible = &quot;nvidia,denver-hardwood&quot;;
compatible = &quot;nvidia,denver15-pmu&quot;;
compatible = &quot;nvidia,eqos&quot;;[net/ethernet/nvidia/eqos/init.c]
compatible = &quot;nvidia,fiq-debugger&quot;;(drivers/staging/android/fiq_debugger/fiq_debugger.c)
compatible = &quot;nvidia,generic_carveout&quot;;
compatible = &quot;nvidia,imx185&quot;; --i2c
compatible = &quot;nvidia,imx219&quot;;
compatible = &quot;nvidia,imx274&quot;;
compatible = &quot;nvidia,mods-clocks&quot;;
compatible = &quot;nvidia,ov23850&quot;;(drivers/media/i2c/ov23850.c)
compatible = &quot;nvidia,ov5693&quot;;
compatible = &quot;nvidia,pca9570&quot;;
compatible = &quot;nvidia,ramoops&quot;;
compatible = &quot;nvidia,smmu_test&quot;;
compatible = &quot;nvidia,storm&quot;, &quot;nvidia,tegra186&quot;;
compatible = &quot;nvidia,t18x-cluster-clk-priv&quot;;
compatible = &quot;nvidia,tegra-audio-t186ref-mobile-rt565x&quot;;
compatible = &quot;nvidia,tegra-gic&quot;;
compatible = &quot;nvidia,tegra-t18x-mc&quot;;
compatible = &quot;nvidia,tegra-wdt-t18x&quot;;
compatible = &quot;nvidia,tegra18-rtc&quot;;
compatible = &quot;nvidia,tegra186&quot;;
compatible = &quot;nvidia,tegra186-AXI2APB-bridge&quot;;[drivers/platform/tegra/bridge_mca.c]
compatible = &quot;nvidia,tegra186-AXIP2P-bridge&quot;;
compatible = &quot;nvidia,tegra186-adma&quot;;
compatible = &quot;nvidia,tegra186-adsp-pd&quot;;(drivers/platform/tegra/pm_domains.c)
compatible = &quot;nvidia,tegra186-ahc&quot;;[drivers/misc/tegra186-ahc/tegra186_ahc.c]
compatible = &quot;nvidia,tegra186-ahci-sata&quot;;(drivers/ata/tegra/ahci_tegra.c)
compatible = &quot;nvidia,tegra186-aon&quot;;[drivers/platform/tegra/tegra-aon.c]
compatible = &quot;nvidia,tegra186-aon-ivc-echo&quot;;
compatible = &quot;nvidia,tegra186-aon-spi&quot;;
compatible = &quot;nvidia,tegra186-aondbg&quot;;
compatible = &quot;nvidia,tegra186-aowake&quot;;
compatible = &quot;nvidia,tegra186-ape-ivc&quot;;[drivers/platform/tegra/tegra-camera-rtcpu.c]
compatible = &quot;nvidia,tegra186-ape-pd&quot;;
compatible = &quot;nvidia,tegra186-arad&quot;;
compatible = &quot;nvidia,tegra186-asrc&quot;;
compatible = &quot;nvidia,tegra186-bpmp&quot;;[drivers/thermal/tegra_bpmp_thermal.c]
compatible = &quot;nvidia,tegra186-bpmp-i2c&quot;;
compatible = &quot;nvidia,tegra186-bpmp-thermal&quot;;
compatible = &quot;nvidia,tegra186-cactmon&quot;;(drivers/platform/tegra/central_actmon/actmon_common.c)
compatible = &quot;nvidia,tegra186-camera-ivc-protocol-capture&quot;;
compatible = &quot;nvidia,tegra186-camera-ivc-protocol-capture-control&quot;;
compatible = &quot;nvidia,tegra186-camera-ivc-protocol-dbg&quot;;
compatible = &quot;nvidia,tegra186-camera-ivc-protocol-debug&quot;;
compatible = &quot;nvidia,tegra186-camera-ivc-protocol-echo&quot;;
compatible = &quot;nvidia,tegra186-camera-ivc-protocol-mods&quot;;
compatible = &quot;nvidia,tegra186-camera-ivc-protocol-vinotify&quot;;
compatible = &quot;nvidia,tegra186-cec&quot;;(drivers/misc/tegra-cec/tegra_cec.c)
compatible = &quot;nvidia,tegra186-chipid&quot;;(drivers/platform/tegra/tegra_chipid.c)
compatible = &quot;nvidia,tegra186-combined-uart&quot;;
compatible = &quot;nvidia,tegra186-cpuidle-a57&quot;;
compatible = &quot;nvidia,tegra186-cpuidle-a57-cluster&quot;;
compatible = &quot;nvidia,tegra186-cpuidle-a57-thresholds&quot;;
compatible = &quot;nvidia,tegra186-cpuidle-denver&quot;;
compatible = &quot;nvidia,tegra186-cpuidle-denver-cluster&quot;;
compatible = &quot;nvidia,tegra186-cpuidle-denver-thresholds&quot;;
compatible = &quot;nvidia,tegra186-dc&quot;;[drivers/video/tegra/dc/dc.c]
compatible = &quot;nvidia,tegra186-disa-pd&quot;;[drivers/video/tegra/dc/nvdisp/nvdisp.c]
compatible = &quot;nvidia,tegra186-dpaux&quot;;
compatible = &quot;nvidia,tegra186-dpaux-pinctrl&quot;;
compatible = &quot;nvidia,tegra186-dpaux1&quot;;
compatible = &quot;nvidia,tegra186-dpaux1-pinctrl&quot;;
compatible = &quot;nvidia,tegra186-dsi&quot;;
compatible = &quot;nvidia,tegra186-dspk&quot;;
compatible = &quot;nvidia,tegra186-dspk&quot;;
compatible = &quot;nvidia,tegra186-efuse&quot;, &quot;nvidia,tegra210-efuse&quot;;
compatible = &quot;nvidia,tegra186-efuse-burn&quot;;
compatible = &quot;nvidia,tegra186-gp10b&quot;, &quot;nvidia,gp10b&quot;;[drivers/gpu/nvgpu/nvgpu_gpuid_t18x.h]
compatible = &quot;nvidia,tegra186-gpcdma&quot;;[drivers/dma/tegra186-gpc-dma.c]
compatible = &quot;nvidia,tegra186-gpio&quot;;
compatible = &quot;nvidia,tegra186-gpio-aon&quot;;
compatible = &quot;nvidia,tegra186-host1x&quot;, &quot;simple-bus&quot;;
compatible = &quot;nvidia,tegra186-host1x-pd&quot;;
compatible = &quot;nvidia,tegra186-hsp&quot;;
compatible = &quot;nvidia,tegra186-hsp-mailbox&quot;;
compatible = &quot;nvidia,tegra186-hsuart&quot;;
compatible = &quot;nvidia,tegra186-i2c&quot;;
compatible = &quot;nvidia,tegra186-iommu-context&quot;;
compatible = &quot;nvidia,tegra186-isp&quot;;[drivers/video/tegra/host/isp/isp.c]
compatible = &quot;nvidia,tegra186-ispa-pd&quot;;
compatible = &quot;nvidia,tegra186-kfuse&quot;;
compatible = &quot;nvidia,tegra186-mc-sid&quot;;
compatible = &quot;nvidia,tegra186-mce&quot;;
compatible = &quot;nvidia,tegra186-miscreg&quot;;
compatible = &quot;nvidia,tegra186-msenc-pd&quot;;
compatible = &quot;nvidia,tegra186-nvcsi&quot;;[drivers/video/tegra/host/nvcsi/nvcsi.c]
compatible = &quot;nvidia,tegra186-nvdec&quot;;[drivers/video/tegra/host/nvdec/nvdec.c]
compatible = &quot;nvidia,tegra186-nvdec-pd&quot;;
compatible = &quot;nvidia,tegra186-nvdumper&quot;;
compatible = &quot;nvidia,tegra186-nvenc&quot;; --drm驱动，主线和外部皆有
compatible = &quot;nvidia,tegra186-nvjpg&quot;; --drm驱动，主线和外部皆有
compatible = &quot;nvidia,tegra186-nvjpg-pd&quot;;
compatible = &quot;nvidia,tegra186-pcie&quot;;
compatible = &quot;nvidia,tegra186-pcie-pd&quot;;
compatible = &quot;nvidia,tegra186-pinmux&quot;;
compatible = &quot;nvidia,tegra186-pm-irq&quot;;
compatible = &quot;nvidia,tegra186-pmc&quot;;
compatible = &quot;nvidia,tegra186-pmc-iopower&quot;;
compatible = &quot;nvidia,tegra186-pwm&quot;;
compatible = &quot;nvidia,tegra186-qspi&quot;;
compatible = &quot;nvidia,tegra186-roc-flush&quot;;
compatible = &quot;nvidia,tegra186-safety-cmd-resp&quot;;
compatible = &quot;nvidia,tegra186-safety-hb&quot;;
compatible = &quot;nvidia,tegra186-safety-ivc&quot;;
compatible = &quot;nvidia,tegra186-sata-pd&quot;;
compatible = &quot;nvidia,tegra186-sce-ivc&quot;;
compatible = &quot;nvidia,tegra186-sdhci&quot;;
compatible = &quot;nvidia,tegra186-se-elp&quot;;（drivers/crypto/tegra-se-elp.c）
compatible = &quot;nvidia,tegra186-se-pd&quot;;
compatible = &quot;nvidia,tegra186-se1-nvhost&quot;; --这个是未主线化的
compatible = &quot;nvidia,tegra186-se2-nvhost&quot;;
compatible = &quot;nvidia,tegra186-se3-nvhost&quot;;
compatible = &quot;nvidia,tegra186-se4-nvhost&quot;;
compatible = &quot;nvidia,tegra186-sor&quot;;
compatible = &quot;nvidia,tegra186-sor1&quot;;
compatible = &quot;nvidia,tegra186-spi&quot;;
compatible = &quot;nvidia,tegra186-spi&quot;;
compatible = &quot;nvidia,tegra186-system-config&quot;;
compatible = &quot;nvidia,tegra186-tachometer&quot;;
compatible = &quot;nvidia,tegra186-timer&quot;;
compatible = &quot;nvidia,tegra186-tsec&quot;;
compatible = &quot;nvidia,tegra186-tsec-pd&quot;;
compatible = &quot;nvidia,tegra186-usb-cd&quot;;
compatible = &quot;nvidia,tegra186-ve-pd&quot;;
compatible = &quot;nvidia,tegra186-vi&quot;; [drivers/video/tegra/host/vi/vi4.c]
compatible = &quot;nvidia,tegra186-vi-bypass&quot;;
compatible = &quot;nvidia,tegra186-vic&quot;;
compatible = &quot;nvidia,tegra186-vic03-pd&quot;;
compatible = &quot;nvidia,tegra186-xhci&quot;;
compatible = &quot;nvidia,tegra186-xotg&quot;;
compatible = &quot;nvidia,tegra186-xudc&quot;;
compatible = &quot;nvidia,tegra186-xusb-mbox&quot;;
compatible = &quot;nvidia,tegra186-xusb-padctl&quot;;
compatible = &quot;nvidia,tegra186-xusba-pd&quot;;
compatible = &quot;nvidia,tegra186-xusbb-pd&quot;;
compatible = &quot;nvidia,tegra186-xusbc-pd&quot;;
compatible = &quot;nvidia,tegra18x-adsp&quot;;
compatible = &quot;nvidia,tegra18x-adsp-carveout&quot;;
compatible = &quot;nvidia,tegra18x-agic&quot;;
compatible = &quot;nvidia,tegra18x-balanced-throttle&quot;;
compatible = &quot;nvidia,tegra18x-car&quot;;
compatible = &quot;nvidia,tegra18x-cpufreq&quot;;
compatible = &quot;nvidia,tegra18x-cpuidle&quot;;
compatible = &quot;nvidia,tegra18x-eqos-ape&quot;;
compatible = &quot;nvidia,tegra20-uart&quot;, &quot;nvidia,tegra186-hsuart&quot;;
compatible = &quot;nvidia,tegra210-admaif&quot;;
compatible = &quot;nvidia,tegra210-adsp-audio&quot;;
compatible = &quot;nvidia,tegra210-adx&quot;;
compatible = &quot;nvidia,tegra210-afc&quot;;
ompatible = &quot;nvidia,tegra210-amixer&quot;;
compatible = &quot;nvidia,tegra210-amx&quot;;(sound/soc/tegra-alt/tegra210_amx_alt.c)
compatible = &quot;nvidia,tegra210-axbar&quot;;
compatible = &quot;nvidia,tegra210-dmic&quot;;
compatible = &quot;nvidia,tegra210-i2s&quot;;
compatible = &quot;nvidia,tegra210-iqc&quot;;
compatible = &quot;nvidia,tegra210-mvc&quot;;
compatible = &quot;nvidia,tegra210-mvc&quot;;
compatible = &quot;nvidia,tegra210-ope&quot;;
compatible = &quot;nvidia,tegra210-pmc-blink-pwm&quot;;
compatible = &quot;nvidia,tegra210-sfc&quot;;
compatible = &quot;nvidia,tegra210-spdif&quot;;
compatible = &quot;nvidia,tegra210-spkprot&quot;;
compatible = &quot;nvidia,tegra30-hda&quot;;
compatible = &quot;nvidia,vpr-carveout&quot;;
compatible = &quot;nxp,pca9546&quot;;
compatible = &quot;pwm-fan&quot;;
compatible = &quot;realtek,rt5658&quot;;(sound/soc/codecs/rt5659.c)
compatible = &quot;regulator-fixed&quot;;
compatible = &quot;regulator-fixed-sync&quot;;
compatible = &quot;s,wqxga-10-1&quot;;
compatible = &quot;s,wqxga-10-1-bl&quot;;
compatible = &quot;s,wuxga-8-0&quot;;
compatible = &quot;s,wuxga-8-0-bl&quot;;
compatible = &quot;s-edp,uhdtv-15-6&quot;;
compatible = &quot;s-edp,uhdtv-15-6-bl&quot;;
compatible = &quot;sharp,lr388k7_ts&quot;;(drivers/input/touchscreen/lr388k7_ts.c)
compatible = &quot;simple-bus&quot;;
compatible = &quot;softdog-platform&quot;;
compatible = &quot;synopsys,dwc_eqos_virt_test&quot;;
compatible = &quot;tegra,ufs_variant&quot;;
compatible = &quot;tegra-power-domains&quot;;
compatible = &quot;thermal-fan-est&quot;;
compatible = &quot;ti,ina3221x&quot;;--大部分是iio驱动
compatible = &quot;ti,lp8556&quot;;
compatible = &quot;ti,tas2552&quot;;
compatible = &quot;ti,tca6408&quot;;
compatible = &quot;ti,tca6416&quot;;
compatible = &quot;ti,tca9539&quot;;
compatible = &quot;ti,tmp451&quot;;
compatible = &quot;ti,tps65132&quot;;
</pre></div>
</div>
<p>显示部分传到主线的大部分都是drm和fb的，没有上传的统一放在一个叫flcn的框架中，里
面的东西包罗万有。</p>
<p>用来支持cuda运算的驱动都没有主线化，也不在flcn中，而是放在driver/gpu目录下，提
供的主要是用户态的接口（通过一组字符设备），和内核的关系不大。</p>
<p>从大量的电源域和调频的设计看，这是从手机改过来的片子。当然，Tegra系列本来就是给
手机做的，这也没有什么可说的。</p>
<p>gk20a的驱动是2014年开始上传主线的，当时的内核版本是3.16，但一直仅包含drm的驱动
。从现在这个代码的样子，应该是一个内部的ML的产品线集成了计算核心到手机SoC中，然
后把对应的代码拼上来了。</p>
<p>查iommu_group，可以看到大部分外设都用iommu_group分割：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sdhci</span> <span class="n">x2</span>
<span class="n">i2c</span> <span class="n">x7</span>
<span class="n">spi</span> <span class="n">x3</span>
<span class="n">serial</span> <span class="n">x4</span>
<span class="n">ether_qos</span>
<span class="n">rtcpu</span>
<span class="n">ahci</span><span class="o">-</span><span class="n">sata</span>
<span class="n">aon</span>
<span class="n">smmu_test</span>
<span class="n">xhci</span>
<span class="n">xudc</span>
<span class="n">host1x</span> <span class="n">x10</span>
<span class="n">host1x</span><span class="p">:</span><span class="n">ctx0</span>
<span class="n">nvcsi</span>
<span class="n">vi</span>
<span class="n">isp</span>
<span class="n">nvdisplay</span>
<span class="n">vic</span>
<span class="n">nvenc</span>
<span class="n">nvdec</span>
<span class="n">i2c</span>
<span class="n">nvjpg</span>
<span class="n">tsec</span>
<span class="n">tsecb</span>
<span class="n">se</span> <span class="n">x4</span>
<span class="n">gp10b</span>
<span class="n">bpmp</span>
<span class="n">dma</span>
<span class="n">pcie</span><span class="o">-</span><span class="n">controller</span>
<span class="n">sound</span>
<span class="n">hda</span>
<span class="n">adsp_audio</span>
<span class="n">adsp</span>
</pre></div>
</div>
<p>片内带一个gpu设备（/sys/device/gpu.0），支持虚拟化，但仅包含一个iommu_group（所
以才支持了vfio-mdev？），驱动是/sys/bus/platform/drivers/gk20a。</p>
<p>gk20a的构架是一个统一的PCI化的设备框架nvgpu，不同的硬件实现则通过一个称为
platform的数据结构进行封装（放在device的priv中），从gk20a的实现看，主要是是些初
始化，时钟一类的东西，也就是说，标准的数据流是统一的设计。我猜这样的构架撑不了
三代（当然，Tegra也不需要），这可能是没有主线化的主要原因。</p>
<p>用户态接口主要暴露为如下字符设备：</p>
<p>/dev/nvhost-gpu：共享内存和通道管理</p>
<p>/dev/nvhost-as-gpu：Address Space</p>
<p>/dev/nvhost-ctrl-gpu：设备状态控制</p>
<p>/dev/nvhost-dbg-gpu：设备调试信息控制</p>
<p>/dev/nvhost-prof-gpu: GPU profiling事件导出和控制</p>
<p>/dev/nvhost-tsg-gpu: 不知道是啥，看起来是做任务控制的</p>
<p>/dev/nvhost-sched-gpu：看起来是tsg的辅助功能，可能前者是任务组管理，后者是调度</p>
<p>其他媒体codec也有类似的结构：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="k">as</span><span class="o">-</span><span class="n">gpu</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">ctrl</span><span class="o">-</span><span class="n">isp</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">ctrl</span><span class="o">-</span><span class="n">vi</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">gpu</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">nvcsi</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">prof</span><span class="o">-</span><span class="n">gpu</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">tsecb</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">vic</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">ctrl</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">ctrl</span><span class="o">-</span><span class="n">nvcsi</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">ctxsw</span><span class="o">-</span><span class="n">gpu</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">isp</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">nvdec</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">sched</span><span class="o">-</span><span class="n">gpu</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">tsg</span><span class="o">-</span><span class="n">gpu</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">ctrl</span><span class="o">-</span><span class="n">gpu</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">ctrl</span><span class="o">-</span><span class="n">nvdec</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">dbg</span><span class="o">-</span><span class="n">gpu</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">msenc</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">nvjpg</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">tsec</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvhost</span><span class="o">-</span><span class="n">vi</span>
</pre></div>
</div>
<p>如果直接看一个cuda的调用过程，主要包括如下动作：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>openat(AT_FDCWD, &quot;/dev/nvhost-ctrl-gpu&quot;, O_RDWR|O_CLOEXEC) = 4
ioctl(4, NVGPU_GPU_IOCTL_GET_CHARACTERISTICS
ioctl(4, NVGPU_GPU_IOCTL_GET_TPC_MASKS
ioctl(4, NVGPU_GPU_IOCTL_GET_FBP_L2_MASKS
ioctl(4, NVGPU_GPU_IOCTL_ZCULL_GET_CTX_SIZE
ioctl(4, NVGPU_GPU_IOCTL_ZCULL_GET_INFO
ioctl(4, NVGPU_GPU_IOCTL_GET_ENGINE_INFO
ioctl(4, NVGPU_GPU_IOCTL_ALLOC_AS //5是这里分配的句柄
ioctl(5, NVGPU_AS_IOCTL_GET_VA_REGIONS
ioctl(5, NVGPU_AS_IOCTL_GET_VA_REGIONS
ioctl(5, NVGPU_AS_IOCTL_ALLOC_SPACE
ioctl(5, NVGPU_AS_IOCTL_ALLOC_SPACE
openat(AT_FDCWD, &quot;/dev/nvmap&quot;, O_RDWR|O_SYNC|O_CLOEXEC) = 9
ioctl(9, NVMAP_IOC_CREATE //和nvmap有关的我们先放下一篇分析里
ioctl(9, NVMAP_IOC_ALLOC
ioctl(5, NVGPU_AS_IOCTL_UNMAP_BUFFER
ioctl(9, NVMAP_IOC_CREATE
ioctl(9, NVMAP_IOC_ALLOC
...上两个调用的多次重复
ioctl(4, NVGPU_GPU_IOCTL_OPEN_TSG
ioctl(4, NVGPU_GPU_IOCTL_OPEN_CHANNEL //这里也是创建句柄，从设备分配一个通道
ioctl(5, NVGPU_AS_IOCTL_BIND_CHANNEL //把channel和AS关联起来
ioctl(4, NVGPU_GPU_IOCTL_OPEN_CHANNEL
ioctl(5, NVGPU_AS_IOCTL_BIND_CHANNEL
ioctl(4, NVGPU_GPU_IOCTL_OPEN_CHANNEL
...
</pre></div>
</div>
<p>简单从这个语义上下文理解，一次通讯是这样的：先从进程和GPU建立一个关联，驱动GPU
的能力，然后分配一个或者多个独立的地址空间（AS），可能是把MMU的一部分复制给SMMU
，然后在设备和进程间建立一个通道，然后把AS和通道绑定，估计这个时候设定streamid
和substreamid给设备，这样剩下的缺页行为就可以交给设备，设备发起缺页中断的时候，
靠进程这边接管对应的mm.handle_fault()，完成后面的过程。</p>
<p>这个设计优先保性能，上传是下一步的事情（也不一定会上传）。</p>
<p>其他没有什么感兴趣了的了，就这样吧。</p>
</div>
<div class="section" id="nvmap">
<h2>nvmap<a class="headerlink" href="#nvmap" title="永久链接至标题">¶</a></h2>
<p>这是这个系列最后一篇，看看TX2的GPU和host是怎么共享内存的。主要是要单独看看nvmap
这个模块的工作原理。</p>
<p>TX2的内核源代码是这样放的：</p>
<blockquote>
<div><div class="line-block">
<div class="line">display kernel-4.4 nvgpu nvgpu-t18x nvhost nvhost-t18x nvmap</div>
<div class="line">nvmap-t18x t18x</div>
</div>
</div></blockquote>
<p>没有上传的代码不是Patch，而是一个个目录树的形态。但里面非常完整，连
NVIDIA-REVIEWERS这种文件都是按MAINTAINER的格式整理的，说起来应该是按随时可以
upstream的方式设计的，但整个功能通用性不强，估计upstream的难度不低。</p>
<p>其中gpu的驱动在nvgpu目录下（如前所述，drm驱动是已经upstream的，在kernel-4.4目录
中）。这个Kernel外的模块代码量93,913Loc)。而nvmap是个独立的目录(代码量6,334Loc
），nvgpu强依赖于nvmap。由于没有资料，nvgpu目录下的程序不太好看懂，很多概念比如
TSG是什么，估计需要分析很久，所以我们从一个相对独立逻辑空间来看看它的语义是怎么
样的。（这也是想介绍一下，应该如何具体解构一个已经存在的设计）</p>
<p>在分析这个逻辑前，我们先看看计算加速器设计中的一个关键问题：内存管理。</p>
<p>比如我做一个大型的矩阵计算，一个100x100的矩阵乘以另一个100x100的矩阵，用32位整
数，这样我就有120000个字节的空间要处理，放到4K的页中，就需要接近30页的内存需要
访问。我一开始在CPU一侧整理这些数据，这些数据当然是放在靠近CPU的内存中比较实在
，这样CPU算起来比较快。但准备好了，我希望这个乘法让加速器（比如GPU）给我算。那
么GPU离这些内存就比较远了，每个乘法加法，都要经过层层总线节点更新到内存里，这还
不如CPU自己算。所以，这是个两难的问题，根据不同的总线带宽和时延，可以考虑的方案
有：</p>
<ol class="arabic simple">
<li>内存选择在CPU一侧（让加速器吃亏）</li>
<li>内存选择在加速器一侧（让CPU吃亏）</li>
<li>内存开始的时候选择在CPU一侧，但某一页的内容被加速器访问的时候，拷贝到GPU一侧
，完成计算后，如果CPU访问这个内存，再从加速器拷贝回CPU一侧。这个过程，既可以
是人工的，也可以是动态的。</li>
</ol>
<p>这里还有一个地址空间的问题，一般的Linux内核驱动，如果一片内存要分享给设备，需要
先做dma=dma_map(va)，其中va是CPU的地址，dma是设备的地址。这样一来，如果CPU要把
一个地址提交给设备，就需要转换到另一个地址空间。这种情况对于那些“弱智外设”，比
如网卡，SAS等控制器，大部分时候做DMA就是为了拷贝一段数据到外设上，这当然没有问
题，但对于那些“智能设备”如加速器，很可能我的数据中就带有指针，我的头指针可以给
你dma_map()，你不能要求我把里面的指针也全部替换了吧？</p>
<p>最后是，现代加速器（特别是计算加速器），基本上要求服务于用户态，所以，前面的问
题，都要在用户态解决。</p>
<p>我们关键看这个代码如何处理这两个问题的。</p>
<p>首先，nvmap的配置项如下（把子配置项和功能无关的项忽略了，只看大特性）：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>NVMAP_HIGHMEM_ONLY：分配内存时仅用HIMEM（64位系统要这东西干嘛？）
NVMAP_PAGE_POOLS：基于内存池管理内存分配
NVMAP_CACHE_MAINT_BY_SET_WAYS：Cache分配算法
NVMAP_DMABUF_STASH：重用DMABUF，降低重新分配成本
NVMAP_FORCE_ZEROED_USER_PAGES：安全功能，分配用户内存
NVMAP_DEFER_FD_RECYCLE：延迟FD号的使用（为后续分配重用）
</pre></div>
</div>
<p>没有什么涉及主功能的配置项，都是优化类的设计，这对构架分析来说是个好消息。</p>
<p>程序入口在nvmap_init中，实现为一个名叫tegra-carveouts的platform_device。查一下
carveout的含义，它是“切割出”的意思，也是CPU侧切出一片内存给GPU用这个商业特性的
名字。</p>
<p>以此为根，遍历整个代码树，功能分列如下：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>nvmap_init.c：平台设备驱动总入口，配置参数管理
nvmap_dev.c：platform_driver实现，注册为misc设备/dev/nvmap，核心是提供ioctl控制
nvmap_ioctl.c：具体实现nvmap_dev.c中的ioctl功能
nvmap_alloc.c：handle分配管理
nvmap.c：基于handle进行内存分配
nvmap_cache.c：在debugfs中创建接口进行cache控制，这里的cache控制指的是CPU一侧的控制，通过调用msr等动作实现的。这个接口的存在，说明CPU和GPU间不是CC的。
nvmap_dmabuf.c：nv版本的dma_buf实现，dma_buf是内核用于用户态直接对设备做DMA的一个封装[1]
nvmap_fault.c：实现vma的ops，进行fault处理，主要从handle预分配的空间中取
nvmap_handle.c：handle管理，主要是做一个rb树，建立vma和处理handle的关联
nvmap_heap.c：kmem_cache的封装（kmem_cache是内核一个管理固定大小内存的一个数据结构），用作CPU/GPU共享内存，这时称为Carveout。
nvmap_mm.c：进程的mm管理，是cache管理的一部分
nvmap_pp.c：page pool管理，自行管理了一个page list，NVMAP_IOC_ALLOC要求分配的也都在这里管理的
nvmap_tag.c：handle的名字管理，提供给handle命名和基于名字访问的能力
</pre></div>
</div>
<p>如果我们把优化性的语义收缩一下，比如pp和heap如果不做池化，就是个简单的
alloc_page()和kmalloc，tag如果不做rb树的管理，就是个handle name。cache操作是CPU
一侧的，不封装就是基本流程中的其中一步……</p>
<p>这样，我们可以初步猜测这个系统的功能是这样构造的：</p>
<p>实现一个平台设备，注册为misc设备，用户态通过ioctl分配handle，基于handle提供vma
的分配，分配后的页面依靠自己管理的page进行填充，提供dma_buf接口，剩下的功能都是
用户态如何基于handle对设备进行硬件交互了。</p>
<p>为了确认这一点，接着看看ioctl的设计：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>NVMAP_IOC_CREATE/NVMAP_IOC_FROM_FD：创建handle和dma_buf
NVMAP_IOC_FROM_VA：同上，但同时设置vma
NVMAP_IOC_FROM_IVC_ID：同上，但同时分配Carveout
NVMAP_IOC_GET_FD：查找功能，FD2handle
NVMAP_IOC_GET_IVC_ID：同上，FD2VimID
NVMAP_IOC_GET_IVM_HEAPS：列出支持IVM的所有carveout内存块
NVMAP_IOC_ALLOC：为handle分配page
NVMAP_IOC_GET_IVC_ID：同上，但从Carveout分配
NVMAP_IOC_VPR_FLOOR_SIZE：似乎是设置特定设备的最小DMA缓冲
NVMAP_IOC_FREE：靠，这是关掉handle的fd（而不是释放Page）
NVMAP_IOC_WRITE/READ：数据读写，WTF，就是说至少部分数据必须通过系统调用来访问（看不到用户库的代码，不好猜）
NVMAP_IOC_CACHE：Cache操作
NVMAP_IOC_CACHE_LIST：同上，维护类功能。
NVMAP_IOC_GUP_TEST：不用test了，这个东西逻辑上肯定是有问题的：用户态DMA的问题
NVMAP_IOC_SET_TAG_LABEL：这是给handle命名
</pre></div>
</div>
<p>基本不改变前面的逻辑，关键是这里有一个Carveout的概念，我猜在普通的实现上，这个
就是普通内存，从CPU直接分配kmemcache来共享，如果是高性能实现，就是不同的内存，
然后靠两边的读写来产生缺页来实现拷贝过程。</p>
<p>再看看handle的数据结构：:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">nvmap_handle</span> <span class="p">{</span>
        <span class="n">struct</span> <span class="n">rb_node</span> <span class="n">node</span><span class="p">;</span>    <span class="o">/*</span> <span class="n">entry</span> <span class="n">on</span> <span class="k">global</span> <span class="n">handle</span> <span class="n">tree</span> <span class="o">*/</span>
        <span class="n">atomic_t</span> <span class="n">ref</span><span class="p">;</span>           <span class="o">/*</span> <span class="n">reference</span> <span class="n">count</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="p">,</span> <span class="c1"># of duplications) */</span>
        <span class="n">atomic_t</span> <span class="n">pin</span><span class="p">;</span>           <span class="o">/*</span> <span class="n">pin</span> <span class="n">count</span> <span class="o">*/</span>
        <span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>              <span class="o">/*</span> <span class="n">caching</span> <span class="n">flags</span> <span class="o">*/</span>
        <span class="n">size_t</span> <span class="n">size</span><span class="p">;</span>            <span class="o">/*</span> <span class="n">padded</span> <span class="p">(</span><span class="k">as</span><span class="o">-</span><span class="n">allocated</span><span class="p">)</span> <span class="n">size</span> <span class="o">*/</span>
        <span class="n">size_t</span> <span class="n">orig_size</span><span class="p">;</span>       <span class="o">/*</span> <span class="n">original</span> <span class="p">(</span><span class="k">as</span><span class="o">-</span><span class="n">requested</span><span class="p">)</span> <span class="n">size</span> <span class="o">*/</span>
        <span class="n">size_t</span> <span class="n">align</span><span class="p">;</span>
        <span class="n">struct</span> <span class="n">nvmap_client</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>
        <span class="n">struct</span> <span class="n">dma_buf</span> <span class="o">*</span><span class="n">dmabuf</span><span class="p">;</span>
        <span class="n">union</span> <span class="p">{</span>
                <span class="n">struct</span> <span class="n">nvmap_pgalloc</span> <span class="n">pgalloc</span><span class="p">;</span>
                <span class="n">struct</span> <span class="n">nvmap_heap_block</span> <span class="o">*</span><span class="n">carveout</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="nb">bool</span> <span class="n">heap_pgalloc</span><span class="p">;</span>      <span class="o">/*</span> <span class="n">handle</span> <span class="ow">is</span> <span class="n">page</span> <span class="n">allocated</span> <span class="p">(</span><span class="n">sysmem</span> <span class="o">/</span> <span class="n">iovmm</span><span class="p">)</span> <span class="o">*/</span>
        <span class="nb">bool</span> <span class="n">alloc</span><span class="p">;</span>             <span class="o">/*</span> <span class="n">handle</span> <span class="n">has</span> <span class="n">memory</span> <span class="n">allocated</span> <span class="o">*/</span>
        <span class="nb">bool</span> <span class="n">from_va</span><span class="p">;</span>           <span class="o">/*</span> <span class="n">handle</span> <span class="n">memory</span> <span class="ow">is</span> <span class="kn">from</span> <span class="nn">VA</span> <span class="o">*/</span>
        <span class="n">u32</span> <span class="n">heap_type</span><span class="p">;</span>          <span class="o">/*</span> <span class="n">handle</span> <span class="n">heap</span> <span class="ow">is</span> <span class="n">allocated</span> <span class="kn">from</span> <span class="o">*/</span>
        <span class="n">u32</span> <span class="n">userflags</span><span class="p">;</span>          <span class="o">/*</span> <span class="n">flags</span> <span class="n">passed</span> <span class="kn">from</span> <span class="nn">userspace</span> <span class="o">*/</span>
        <span class="n">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>            <span class="o">/*</span> <span class="n">mapping</span> <span class="n">used</span> <span class="n">inside</span> <span class="n">kernel</span> <span class="o">*/</span>
        <span class="n">struct</span> <span class="n">list_head</span> <span class="n">vmas</span><span class="p">;</span>  <span class="o">/*</span> <span class="nb">list</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">user</span> <span class="n">vma</span><span class="s1">&#39;s */</span>
        <span class="n">atomic_t</span> <span class="n">umap_count</span><span class="p">;</span>    <span class="o">/*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">outstanding</span> <span class="n">maps</span> <span class="kn">from</span> <span class="nn">user</span> <span class="o">*/</span>
        <span class="n">atomic_t</span> <span class="n">kmap_count</span><span class="p">;</span>    <span class="o">/*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">outstanding</span> <span class="nb">map</span> <span class="kn">from</span> <span class="nn">kernel</span> <span class="o">*/</span>
        <span class="n">atomic_t</span> <span class="n">share_count</span><span class="p">;</span>   <span class="o">/*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">processes</span> <span class="n">sharing</span> <span class="n">the</span> <span class="n">handle</span> <span class="o">*/</span>
        <span class="n">struct</span> <span class="n">list_head</span> <span class="n">lru</span><span class="p">;</span>   <span class="o">/*</span> <span class="nb">list</span> <span class="n">head</span> <span class="n">to</span> <span class="n">track</span> <span class="n">the</span> <span class="n">lru</span> <span class="o">*/</span>
        <span class="n">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>
        <span class="n">struct</span> <span class="n">list_head</span> <span class="n">dmabuf_priv</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">ivm_id</span><span class="p">;</span>
        <span class="nb">int</span> <span class="n">peer</span><span class="p">;</span>               <span class="o">/*</span> <span class="n">Peer</span> <span class="n">VM</span> <span class="n">number</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
<p>rbtree，成组的vma，多个dmabuf，cpu/gpu二选一的page或者carveout……基本上和前面的
逻辑一致。</p>
<p>再快速查一次nvgpu一侧的代码，除了by-pass-smmu以外，没有独立的SMMU操作，查所有的
中断处理，都是关于channel的，没有关于SMMU的中断处理，所以基本上可以认为，这个方
案是处理不了设备一侧的缺页的。</p>
<p>这个方案看起来挺……简陋的，重点还是聚焦在基本功能架构的一般优化上，没到向上提炼
构架的程度。</p>
<p>从功能上说，最不好的一点就是和IOMMU是结合不起来的，但它完全基于FD的管理比
WrapDrive基于vfio-mdev的管理带来一个好处，就是进程退出，通道就自动回收了，WD现
在做这个功能不好做。另外，WD需要考虑这里的另外两个需求：</p>
<ol class="arabic simple">
<li>它的Host和加速器之间不是CC的，得有个办法把Cache操作插入到语义中</li>
<li>WD现在没有考虑支持大页</li>
</ol>
<div class="section" id="id2">
<h3>附录<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h3>
<dl class="docutils">
<dt>[1] dma_buf的功能在内核Documentation/driver-api/dma-buf.rst中表述。如果我没</dt>
<dd>有记错，这是当初三星在Linaro首先推的特性，它主要解决像视频播放器这种：需要
软件动两下，转给硬件动两下，然后软件再动两下，交给下个硬件动两下这样的场景
的。它的核心就是让用户态可以分配一片DMA内存，然后让这个内存可以在多个驱动和
进程之间互相传递。</dd>
</dl>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Progress and confusion of the IOMMU name space.html" class="btn btn-neutral float-right" title="Progress and confusion of the IOMMU name space" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="抽象还是不抽象的问题.html" class="btn btn-neutral float-left" title="抽象还是不抽象的问题" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Kenneth Lee

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>